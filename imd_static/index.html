<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Markdown Preview</title>
  
  <!-- Syntax highlighting from highlight.js -->
  <link rel="stylesheet" href="/node_modules/highlight.js/styles/github.min.css">
  <!-- GitHub-style markdown rendering -->
  <link rel="stylesheet" href="/github-markdown.css">
  <!-- KaTeX math rendering -->
  <link rel="stylesheet" href="/node_modules/katex/dist/katex.min.css">

  <style>
    /* Base layout */
    body {
      min-width: 200px;
      margin: 0;
      padding: 0;
      background: #fff;
    }
    
    .container {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }
    
    #readme .markdown-body,
    #readme .plain {
      border: none;
    }
    
    .markdown-body {
      min-width: 200px;
      max-width: 800px;
      margin: 0 auto;
      padding: 30px;
      box-sizing: border-box;
    }
    
    /* Connection error indicator */
    #con-error {
      position: fixed;
      top: 0;
      right: 0;
      padding: 8px 16px;
      background: #fef2f2;
      color: #dc2626;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      font-size: 14px;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 9999;
    }

    /* Mermaid diagram styles */
    .markdown-body pre.mermaid {
      cursor: zoom-in;
      transition: box-shadow 0.2s ease;
      border-radius: 8px;
      padding: 16px;
      background: #f8f9fa;
      overflow: hidden;
      max-width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .markdown-body pre.mermaid:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .markdown-body pre.mermaid svg {
      display: block;
      max-width: 100%;
      height: auto;
    }

    /* Diagram zoom modal */
    #diagram-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: #ffffff;
      z-index: 10000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      overflow: auto;
    }
    
    #diagram-modal.active {
      display: flex;
    }
    
    #diagram-modal-content {
      max-width: 95vw;
      max-height: calc(100vh - 100px);
      overflow-x: hidden;
      overflow-y: auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }
    
    #diagram-modal-content svg {
      max-width: 100%;
      height: auto;
    }
    
    #diagram-modal-close {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      border: none;
      background: #f3f4f6;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      color: #374151;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.2s ease, transform 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 10001;
    }
    
    #diagram-modal-close:hover {
      background: #e5e7eb;
      transform: scale(1.1);
    }
    
    #diagram-modal-hint {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: #6b7280;
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="container">
      <div class="repository-with-sidebar repo-container">
        <div id="js-repo-pjax-container" class="repository-content">
          <div id="readme" class="boxed-group flush clearfix announce instapaper_body md">
            <article class="markdown-body"></article>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="con-error" style="display:none">Live preview disconnected</div>
  
  <!-- Diagram zoom modal -->
  <div id="diagram-modal" onclick="if(event.target === this) window.closeDiagramModal();">
    <button id="diagram-modal-close" onclick="window.closeDiagramModal();" title="Close (Esc)" aria-label="Close modal">Ã—</button>
    <div id="diagram-modal-content"></div>
    <div id="diagram-modal-hint">Click outside or press Esc to close</div>
  </div>

  <!-- Socket.io client (v4) -->
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- Main application script -->
  <script type="module">
    // ==========================================================================
    // Mermaid Initialization
    // ==========================================================================
    
import mermaid from '/mermaid.esm.min.mjs';
import elkLayouts from '/mermaid-layout-elk.esm.min.mjs';
    
    // Register ELK layout algorithms for better diagram rendering
    mermaid.registerLayoutLoaders(elkLayouts);
    
    // Expose mermaid globally for use in event handlers
    window.mermaid = mermaid;
    
    mermaid.initialize({
      startOnLoad: false,
      theme: 'default',
      layout: 'elk',
      elk: {
        mergeEdges: true,
        nodePlacementStrategy: 'NETWORK_SIMPLEX',
        'elk.hierarchyHandling': 'INCLUDE_CHILDREN',
        'elk.algorithm': 'layered',
        'elk.layered.spacing.nodeNodeBetweenLayers': '50',
        'elk.spacing.nodeNode': '30',
        'elk.padding': '[top=20,left=20,bottom=20,right=20]'
      },
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: 'basis',
        nodeSpacing: 40,
        rankSpacing: 60,
        padding: 20,
        diagramPadding: 10,
        defaultRenderer: 'elk',
        subGraphTitleMargin: { top: 10, bottom: 10 }
      },
      sequence: {
        actorMargin: 80,
        boxMargin: 10,
        boxTextMargin: 5,
        noteMargin: 10,
        messageMargin: 35,
        mirrorActors: true,
        useMaxWidth: false
      },
      gantt: {
        useMaxWidth: false,
        barHeight: 30,
        barGap: 8,
        topPadding: 50,
        leftPadding: 75,
        gridLineStartPadding: 35,
        fontSize: 12,
        sectionFontSize: 14
      },
      er: {
        useMaxWidth: false,
        entityPadding: 15,
        minEntityWidth: 100,
        minEntityHeight: 75
      },
      pie: {
        useMaxWidth: false,
        textPosition: 0.75
      },
      class: {
        useMaxWidth: false,
        padding: 10
      }
    });

    // ==========================================================================
    // Socket.io Connection (v4 API)
    // ==========================================================================
    
    function initSocket() {
      // Socket.io v4 uses io() directly
      const socket = io({
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 10
      });
      
      socket.on('connect', () => {
        console.log('Connected to server');
        setDisconnected(false);
      });
      
      socket.on('disconnect', () => {
        console.log('Disconnected from server');
        setDisconnected(true);
      });
      
      socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        setDisconnected(true);
      });
      
      // Listen for markdown content updates
      socket.on('newContent', handleContentUpdate);
      
      // Listen for shutdown signal
      socket.on('die', handleShutdown);
    }
    
    async function handleContentUpdate(newHTML) {
      const markdownBody = document.querySelector('.markdown-body');
      if (!markdownBody) return;
      
      markdownBody.innerHTML = newHTML;
      
      // Render mermaid diagrams
      if (window.mermaid) {
        try {
          await window.mermaid.run();
        } catch (error) {
          console.error('Mermaid rendering error:', error);
        }
      }
      
      // Attach zoom handlers to diagrams
      window.attachDiagramZoomHandlers();
      
      // Scroll to marker if present (for cursor tracking)
      const marker = document.getElementById('imdmarker');
      if (marker) {
        marker.scrollIntoView({ block: 'center', behavior: 'smooth' });
      }
    }
    
    function handleShutdown() {
      // Attempt to close the window
      window.open('', '_self', '');
      window.close();
      
      // Fallback message for browsers that block window.close()
      document.body.innerHTML = `
        <div style="padding: 40px; text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;">
          <h1>Preview Closed</h1>
          <p>Please close this tab manually.</p>
          <p style="color: #666; font-size: 14px;">
            Tip: In Firefox, go to about:config and set <code>dom.allow_scripts_to_close_windows</code> to <code>true</code>
            for automatic tab closing.
          </p>
        </div>
      `;
    }
    
    function setDisconnected(isDisconnected) {
      const errorEl = document.getElementById('con-error');
      if (errorEl) {
        errorEl.style.display = isDisconnected ? 'block' : 'none';
      }
    }

    // ==========================================================================
    // Diagram Zoom Modal
    // ==========================================================================
    
    window.attachDiagramZoomHandlers = function() {
      const diagrams = document.querySelectorAll('.markdown-body pre.mermaid');
      
      diagrams.forEach((diagram) => {
        // Remove existing listener to avoid duplicates
        diagram.removeEventListener('click', window.openDiagramModal);
        diagram.addEventListener('click', window.openDiagramModal);
        
        // Scale diagram to fit container
        const svg = diagram.querySelector('svg');
        if (svg) {
          scaleSvgToFit(svg, diagram);
        }
      });
    };
    
    function scaleSvgToFit(svg, container) {
      const viewBox = svg.getAttribute('viewBox');
      if (!viewBox) return;
      
      const [, , vbWidth, vbHeight] = viewBox.split(' ').map(parseFloat);
      const containerWidth = container.clientWidth - 32; // Account for padding
      
      if (vbWidth > containerWidth && containerWidth > 0) {
        const scale = containerWidth / vbWidth;
        const scaledHeight = vbHeight * scale;
        
        svg.style.width = `${containerWidth}px`;
        svg.style.height = `${scaledHeight}px`;
        svg.style.maxWidth = '100%';
      }
    }
    
    window.openDiagramModal = function(event) {
      const diagram = event.currentTarget;
      const svg = diagram.querySelector('svg');
      if (!svg) return;
      
      const modal = document.getElementById('diagram-modal');
      const modalContent = document.getElementById('diagram-modal-content');
      
      // Clear previous content
      modalContent.innerHTML = '';
      
      // Clone SVG and reset styles
      const svgClone = svg.cloneNode(true);
      svgClone.style.cssText = '';
      
      // Scale to fill width, allow vertical scroll for tall diagrams
      const viewBox = svg.getAttribute('viewBox');
      if (viewBox) {
        const [, , vbWidth, vbHeight] = viewBox.split(' ').map(parseFloat);
        const aspectRatio = vbWidth / vbHeight;
        
        const finalWidth = window.innerWidth * 0.92;
        const finalHeight = finalWidth / aspectRatio;
        
        svgClone.setAttribute('width', `${finalWidth}px`);
        svgClone.setAttribute('height', `${finalHeight}px`);
        svgClone.style.width = `${finalWidth}px`;
        svgClone.style.height = `${finalHeight}px`;
        svgClone.style.maxWidth = 'none';
        svgClone.style.display = 'block';
      }
      
      modalContent.appendChild(svgClone);
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    };
    
    window.closeDiagramModal = function() {
      const modal = document.getElementById('diagram-modal');
      const modalContent = document.getElementById('diagram-modal-content');
      
      modal.classList.remove('active');
      document.body.style.overflow = '';
      
      // Clear content to prevent ghosting
      modalContent.innerHTML = '';
    };
    
    // Close modal on Escape key
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        window.closeDiagramModal();
      }
    });

    // ==========================================================================
    // CSP Detection
    // ==========================================================================
    
    try {
      // This eval will fail if CSP is active
      eval('/* CSP test */');
    } catch {
      // CSP is active - add restrictive policy for rendered content
      const meta = document.createElement('meta');
      meta.setAttribute('http-equiv', 'Content-Security-Policy');
      meta.setAttribute('content', "script-src 'none';");
      document.head.appendChild(meta);
    }

    // ==========================================================================
    // Initialize
    // ==========================================================================
    
    initSocket();
  </script>
</body>
</html>
